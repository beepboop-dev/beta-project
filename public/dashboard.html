<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MenuCraft ‚Äî Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root { --orange: #E85D2C; --orange-dark: #D14A1C; --cream: #FFFBF7; --charcoal: #1A1A1A; --gray: #6B7280; --green: #10B981; --red: #EF4444; }
    body { font-family: 'Inter', sans-serif; background: #F9FAFB; color: var(--charcoal); }

    /* MOBILE NAV */
    .mobile-nav {
      display: none;
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
      background: #fff; border-top: 1px solid #E5E7EB;
      padding: 6px 0 env(safe-area-inset-bottom, 6px);
    }
    .mobile-nav-inner {
      display: flex; justify-content: space-around;
    }
    .mobile-nav a {
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      text-decoration: none; color: var(--gray); font-size: 10px; font-weight: 600;
      padding: 4px 12px; border-radius: 8px; transition: color 0.2s;
    }
    .mobile-nav a.active { color: var(--orange); }
    .mobile-nav a span.icon { font-size: 20px; }

    /* SIDEBAR */
    .sidebar {
      position: fixed; left: 0; top: 0; bottom: 0; width: 240px;
      background: #fff; border-right: 1px solid #E5E7EB; padding: 20px;
      display: flex; flex-direction: column; z-index: 50;
    }
    .sidebar .logo { font-size: 20px; font-weight: 800; color: var(--orange); margin-bottom: 32px; text-decoration: none; }
    .sidebar .logo span { color: var(--charcoal); }
    .sidebar-nav { flex: 1; }
    .sidebar-nav a {
      display: flex; align-items: center; gap: 10px; padding: 10px 12px;
      border-radius: 10px; text-decoration: none; color: var(--gray);
      font-size: 14px; font-weight: 500; margin-bottom: 4px; transition: all 0.2s;
    }
    .sidebar-nav a:hover, .sidebar-nav a.active { background: var(--cream); color: var(--charcoal); }
    .sidebar-nav a.active { font-weight: 600; }
    .sidebar-bottom { border-top: 1px solid #F3F4F6; padding-top: 16px; }
    .sidebar-bottom .user-email { font-size: 12px; color: var(--gray); margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; }
    .sidebar-bottom a { font-size: 13px; color: var(--red); text-decoration: none; font-weight: 500; }

    /* MAIN */
    .main { margin-left: 240px; padding: 32px; min-height: 100vh; }
    .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .main-header h1 { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }

    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 10px 20px; border-radius: 10px; font-weight: 600;
      font-size: 13px; text-decoration: none; transition: all 0.2s;
      border: none; cursor: pointer; font-family: inherit;
    }
    .btn-primary { background: var(--orange); color: #fff; }
    .btn-primary:hover { background: var(--orange-dark); }
    .btn-outline { background: #fff; color: var(--charcoal); border: 1.5px solid #E5E7EB; }
    .btn-outline:hover { border-color: #D1D5DB; }
    .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 8px; }
    .btn-danger { background: #FEE2E2; color: var(--red); }
    .btn-danger:hover { background: #FECACA; }
    .btn-green { background: #ECFDF5; color: var(--green); }

    .card {
      background: #fff; border-radius: 16px; border: 1px solid #E5E7EB;
      padding: 24px; margin-bottom: 16px;
    }

    /* MENU SELECTOR */
    .menu-selector {
      display: flex; align-items: center; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
    }
    .menu-selector select {
      padding: 8px 12px; border: 1.5px solid #E5E7EB; border-radius: 10px;
      font-size: 14px; font-family: inherit; font-weight: 600; outline: none;
      background: #fff; cursor: pointer; min-width: 180px;
    }
    .menu-selector select:focus { border-color: var(--orange); }

    .menu-url-bar {
      display: flex; align-items: center; gap: 12px;
      background: #fff; border: 1.5px solid #E5E7EB; border-radius: 12px;
      padding: 10px 16px; margin-bottom: 20px;
      overflow: hidden;
    }
    .menu-url-bar .label { font-size: 12px; font-weight: 600; color: var(--gray); white-space: nowrap; }
    .menu-url-bar .url { font-size: 13px; color: var(--orange); font-weight: 600; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .menu-url-bar .url a { color: inherit; text-decoration: none; }
    .menu-url-bar .url a:hover { text-decoration: underline; }

    /* TABS */
    .tabs { display: flex; gap: 4px; margin-bottom: 24px; background: #F3F4F6; border-radius: 10px; padding: 4px; width: fit-content; max-width: 100%; overflow-x: auto; }
    .tab {
      padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600;
      cursor: pointer; background: transparent; color: var(--gray); border: none; font-family: inherit; white-space: nowrap;
    }
    .tab.active { background: #fff; color: var(--charcoal); box-shadow: 0 1px 3px rgba(0,0,0,0.08); }

    .category-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px; flex-wrap: wrap; gap: 8px;
    }
    .category-header h3 { font-size: 18px; font-weight: 700; }
    .category-actions { display: flex; gap: 8px; }

    .item-row {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 0; border-bottom: 1px solid #F3F4F6;
    }
    .item-row:last-child { border-bottom: none; }
    .item-thumb {
      width: 44px; height: 44px; border-radius: 8px; object-fit: cover;
      background: #F3F4F6; flex-shrink: 0;
    }
    .item-thumb-placeholder {
      width: 44px; height: 44px; border-radius: 8px;
      background: #F3F4F6; display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: #D1D5DB; flex-shrink: 0;
    }
    .item-info { flex: 1; min-width: 0; }
    .item-name { font-size: 14px; font-weight: 600; }
    .item-desc { font-size: 12px; color: var(--gray); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .item-tags { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
    .item-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #ECFDF5; color: #059669; font-weight: 600; }
    .item-price { font-size: 14px; font-weight: 700; color: var(--orange); white-space: nowrap; }
    .item-actions { display: flex; gap: 4px; }
    .icon-btn { padding: 6px 8px; border: none; background: transparent; cursor: pointer; font-size: 14px; border-radius: 6px; }
    .icon-btn:hover { background: #F3F4F6; }

    /* MODAL */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000;
      display: none; align-items: center; justify-content: center; padding: 16px;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #fff; border-radius: 20px; padding: 28px;
      width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto;
    }
    .modal h3 { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #374151; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 10px 12px; border: 1.5px solid #E5E7EB; border-radius: 10px;
      font-size: 14px; font-family: inherit; outline: none; transition: border-color 0.2s;
    }
    .form-group input:focus, .form-group textarea:focus { border-color: var(--orange); }
    .form-group textarea { resize: vertical; min-height: 60px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px; }
    .tag-picker { display: flex; gap: 6px; flex-wrap: wrap; }
    .tag-chip {
      padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;
      cursor: pointer; border: 1.5px solid #E5E7EB; background: #fff; color: var(--gray);
      transition: all 0.2s; font-family: inherit;
    }
    .tag-chip.selected { border-color: var(--green); background: #ECFDF5; color: #059669; }

    .qr-container { text-align: center; }
    .qr-container img { max-width: 256px; margin: 16px auto; border-radius: 12px; }
    .qr-url { font-size: 14px; color: var(--orange); font-weight: 600; word-break: break-all; margin-bottom: 16px; }

    .color-picker-group { display: flex; align-items: center; gap: 12px; }
    .color-picker-group input[type="color"] {
      width: 48px; height: 48px; border: 2px solid #E5E7EB; border-radius: 10px; padding: 2px; cursor: pointer;
    }
    .color-label { font-size: 14px; font-weight: 500; }

    .upgrade-banner {
      background: linear-gradient(135deg, var(--orange), #F59E0B);
      color: #fff; padding: 20px 24px; border-radius: 16px;
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
    }
    .upgrade-banner h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .upgrade-banner p { font-size: 13px; opacity: 0.9; }
    .upgrade-banner .btn { background: #fff; color: var(--orange); }

    /* IMAGE UPLOAD */
    .image-upload-area {
      border: 2px dashed #E5E7EB; border-radius: 12px; padding: 16px;
      text-align: center; cursor: pointer; transition: all 0.2s;
      position: relative; min-height: 80px;
      display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 6px;
    }
    .image-upload-area:hover { border-color: var(--orange); background: #FFFBF7; }
    .image-upload-area img { max-width: 100%; max-height: 120px; border-radius: 8px; object-fit: cover; }
    .image-upload-area .upload-text { font-size: 13px; color: var(--gray); }
    .image-upload-area input { display: none; }

    .toast {
      position: fixed; bottom: 80px; right: 24px; background: var(--charcoal); color: #fff;
      padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 600;
      opacity: 0; transform: translateY(10px); transition: all 0.3s; z-index: 2000;
    }
    .toast.show { opacity: 1; transform: translateY(0); }

    /* Theme picker */
    .theme-picker { display: flex; gap: 12px; flex-wrap: wrap; }
    .theme-option {
      cursor: pointer; text-align: center; padding: 8px; border-radius: 12px;
      border: 2px solid #E5E7EB; transition: all 0.2s; width: 80px;
    }
    .theme-option:hover { border-color: #D1D5DB; }
    .theme-option.selected { border-color: var(--orange); background: var(--cream); }
    .theme-preview { width: 100%; height: 48px; border-radius: 8px; margin-bottom: 6px; }
    .theme-option span { font-size: 11px; font-weight: 600; color: var(--gray); }
    .theme-option.selected span { color: var(--orange); }

    /* Availability toggle */
    .avail-toggle {
      position: relative; width: 36px; height: 20px; flex-shrink: 0;
    }
    .avail-toggle input { opacity: 0; width: 0; height: 0; }
    .avail-toggle .slider {
      position: absolute; inset: 0; background: #D1D5DB; border-radius: 20px;
      cursor: pointer; transition: background 0.2s;
    }
    .avail-toggle .slider::before {
      content: ''; position: absolute; left: 2px; top: 2px;
      width: 16px; height: 16px; background: #fff; border-radius: 50%;
      transition: transform 0.2s;
    }
    .avail-toggle input:checked + .slider { background: var(--green); }
    .avail-toggle input:checked + .slider::before { transform: translateX(16px); }
    .item-row.unavailable { opacity: 0.45; }
    .item-row.unavailable .item-name { text-decoration: line-through; }
    .sold-badge { font-size: 10px; font-weight: 700; color: var(--red); background: #FEE2E2; padding: 1px 6px; border-radius: 4px; margin-left: 6px; }

    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main { margin-left: 0; padding: 16px; padding-bottom: 80px; }
      .mobile-nav { display: block; }
      .main-header { flex-direction: column; align-items: flex-start; }
      .main-header > div { width: 100%; display: flex; gap: 8px; }
      .main-header > div .btn { flex: 1; justify-content: center; font-size: 12px; padding: 10px 12px; }
      .form-row { grid-template-columns: 1fr; }
      .menu-url-bar { flex-direction: column; align-items: flex-start; gap: 4px; }
      .item-row { gap: 8px; }
      .category-header { flex-direction: column; align-items: flex-start; }
      .toast { bottom: 90px; left: 16px; right: 16px; text-align: center; }
    }

    /* DRAG AND DROP */
    .drag-handle {
      cursor: grab; font-size: 16px; color: #D1D5DB; padding: 4px;
      user-select: none; flex-shrink: 0; touch-action: none;
    }
    .drag-handle:hover { color: var(--gray); }
    .drag-handle:active { cursor: grabbing; }
    .card[draggable="true"] { cursor: default; transition: opacity 0.2s, transform 0.2s; }
    .card[draggable="true"].dragging { opacity: 0.4; transform: scale(0.98); }
    .card.drag-over-top { border-top: 3px solid var(--orange); }
    .card.drag-over-bottom { border-bottom: 3px solid var(--orange); }
    .item-row[draggable="true"] { transition: opacity 0.2s; }
    .item-row[draggable="true"].dragging { opacity: 0.3; background: #FFF7ED; }
    .item-row.drag-over-top { box-shadow: inset 0 3px 0 var(--orange); }
    .item-row.drag-over-bottom { box-shadow: inset 0 -3px 0 var(--orange); }
  </style>
</head>
<body>

<div class="sidebar">
  <a href="/" class="logo">Menu<span>Craft</span></a>
  <div class="sidebar-nav">
    <a href="#" class="active" data-tab="editor">üìù Menu Editor</a>
    <a href="#" data-tab="design">üé® Design</a>
    <a href="#" data-tab="qr">üì∑ QR Code</a>
    <a href="#" data-tab="restaurant">üè™ Restaurant Info</a>
    <a href="#" data-tab="specials">üî• Specials</a>
    <a href="#" data-tab="languages">üåç Languages</a>
    <a href="#" data-tab="settings">‚öôÔ∏è Settings</a>
  </div>
  <div class="sidebar-bottom">
    <div class="user-email" id="user-email">loading...</div>
    <a href="#" onclick="logout()">Log out</a>
  </div>
</div>

<div class="mobile-nav">
  <div class="mobile-nav-inner">
    <a href="#" class="active" data-tab="editor"><span class="icon">üìù</span>Editor</a>
    <a href="#" data-tab="design"><span class="icon">üé®</span>Design</a>
    <a href="#" data-tab="qr"><span class="icon">üì∑</span>QR</a>
    <a href="#" data-tab="specials"><span class="icon">üî•</span>Specials</a>
    <a href="#" data-tab="languages"><span class="icon">üåç</span>Lang</a>
    <a href="#" data-tab="settings"><span class="icon">‚öôÔ∏è</span>Settings</a>
  </div>
</div>

<div class="main">
  <div class="main-header">
    <h1 id="page-title">Menu Editor</h1>
    <div>
      <a id="preview-link" href="#" target="_blank" class="btn btn-outline">üëÅ Preview</a>
      <button class="btn btn-primary" onclick="showQRModal()">üì∑ QR Code</button>
    </div>
  </div>

  <!-- Menu selector -->
  <div class="menu-selector" id="menu-selector-bar">
    <select id="menu-select" onchange="switchMenu()"></select>
    <button class="btn btn-sm btn-outline" onclick="addMenu()">+ New Menu</button>
    <button class="btn btn-sm btn-danger" id="delete-menu-btn" onclick="deleteMenu()" style="display:none;">üóë</button>
  </div>

  <div class="menu-url-bar">
    <span class="label">Menu URL:</span>
    <span class="url"><a id="menu-url-display" href="#" target="_blank">loading...</a></span>
    <button class="btn btn-sm btn-outline" onclick="copyMenuUrl()">Copy</button>
  </div>

  <!-- EDITOR TAB -->
  <div id="tab-editor">
    <div id="categories-container"></div>
    <button class="btn btn-outline" onclick="addCategory()" style="margin-top:16px;">+ Add Category</button>
  </div>

  <!-- DESIGN TAB -->
  <div id="tab-design" style="display:none;">
    <div class="card">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:20px;">Customize Your Menu</h3>
      <div class="form-group">
        <label>Menu Name</label>
        <input type="text" id="design-menu-name" onchange="saveDesign()">
      </div>
      <div class="form-group">
        <label>Subtitle / Description</label>
        <textarea id="design-description" onchange="saveDesign()" placeholder="e.g. Italian Restaurant ¬∑ Downtown"></textarea>
      </div>
      <div class="form-row" style="margin-bottom:16px;">
        <div class="form-group">
          <label>Primary Color</label>
          <div class="color-picker-group">
            <input type="color" id="design-primary" value="#E85D2C" onchange="saveDesign()">
            <span class="color-label" id="primary-label">#E85D2C</span>
          </div>
        </div>
        <div class="form-group">
          <label>Background Color</label>
          <div class="color-picker-group">
            <input type="color" id="design-bg" value="#FFFBF7" onchange="saveDesign()">
            <span class="color-label" id="bg-label">#FFFBF7</span>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>Font</label>
        <select id="design-font" onchange="saveDesign()">
          <option value="Inter">Inter (Modern)</option>
          <option value="Georgia">Georgia (Classic)</option>
          <option value="Playfair Display">Playfair Display (Elegant)</option>
          <option value="Lora">Lora (Refined)</option>
          <option value="DM Sans">DM Sans (Clean)</option>
          <option value="Cormorant Garamond">Cormorant Garamond (Fancy)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Menu Theme</label>
        <div class="theme-picker" id="theme-picker">
          <div class="theme-option" data-theme="classic" onclick="selectTheme('classic')">
            <div class="theme-preview" style="background:linear-gradient(135deg,#E85D2C,#F59E0B);"></div>
            <span>Classic</span>
          </div>
          <div class="theme-option" data-theme="modern" onclick="selectTheme('modern')">
            <div class="theme-preview" style="background:#111;"></div>
            <span>Modern</span>
          </div>
          <div class="theme-option" data-theme="elegant" onclick="selectTheme('elegant')">
            <div class="theme-preview" style="background:linear-gradient(135deg,#2C1810,#4A2C20);"></div>
            <span>Elegant</span>
          </div>
          <div class="theme-option" data-theme="casual" onclick="selectTheme('casual')">
            <div class="theme-preview" style="background:#E85D2C;"></div>
            <span>Casual</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR TAB -->
  <div id="tab-qr" style="display:none;">
    <div class="card qr-container" id="qr-content">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:8px;">Your QR Code</h3>
      <p style="font-size:14px;color:var(--gray);margin-bottom:16px;">Print this and place it on your tables</p>
      <img id="qr-image" src="" alt="QR Code">
      <div class="qr-url" id="qr-url"></div>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
        <button class="btn btn-outline" onclick="downloadQR()">‚¨á Download QR Image</button>
        <button class="btn btn-primary" onclick="downloadQRCard()">üñ® Print-Ready QR Card</button>
      </div>
    </div>
  </div>

  <!-- RESTAURANT INFO TAB -->
  <div id="tab-restaurant" style="display:none;">
    <div class="card">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:20px;">Restaurant Information</h3>
      <p style="font-size:13px;color:var(--gray);margin-bottom:20px;">This info appears on your public menu page.</p>
      <div class="form-group">
        <label>Restaurant Name</label>
        <input type="text" id="rest-name" placeholder="e.g. Bella Cucina">
      </div>
      <div class="form-group">
        <label>Hours</label>
        <input type="text" id="rest-hours" placeholder="e.g. Mon-Sat 11am-10pm, Sun 12pm-9pm">
      </div>
      <div class="form-group">
        <label>Location / Address</label>
        <input type="text" id="rest-location" placeholder="e.g. 123 Main St, Downtown">
      </div>
      <div class="form-group">
        <label>Phone</label>
        <input type="text" id="rest-phone" placeholder="e.g. (555) 123-4567">
      </div>
      <button class="btn btn-primary" onclick="saveRestaurantInfo()">Save Info</button>
    </div>
  </div>


  <!-- SPECIALS TAB -->
  <div id="tab-specials" style="display:none;">
    <!-- Custom Standalone Specials -->
    <div class="card" style="margin-bottom:20px;">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:4px;">‚≠ê Custom Daily Specials</h3>
      <p style="font-size:13px;color:var(--gray);margin-bottom:16px;">Create standalone specials with day-of-week scheduling. They auto-show/hide on your public menu.</p>
      <div id="custom-specials-list"></div>
      <button class="btn btn-primary" onclick="openCreateCustomSpecial()" style="margin-top:12px;">+ Create New Special</button>
    </div>

    <!-- Item-Based Specials by Day -->
    <div class="card" style="margin-bottom:20px;">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:4px;">üè∑Ô∏è Menu Item Discounts</h3>
      <p style="font-size:13px;color:var(--gray);margin-bottom:16px;">Discount existing menu items for specific days.</p>
      <div class="form-group">
        <label>Select Day</label>
        <div class="tabs" style="width:100%;">
          <button class="tab" data-sday="1" onclick="selectSpecialDay(1)">Mon</button>
          <button class="tab" data-sday="2" onclick="selectSpecialDay(2)">Tue</button>
          <button class="tab" data-sday="3" onclick="selectSpecialDay(3)">Wed</button>
          <button class="tab" data-sday="4" onclick="selectSpecialDay(4)">Thu</button>
          <button class="tab" data-sday="5" onclick="selectSpecialDay(5)">Fri</button>
          <button class="tab" data-sday="6" onclick="selectSpecialDay(6)">Sat</button>
          <button class="tab" data-sday="0" onclick="selectSpecialDay(0)">Sun</button>
        </div>
      </div>
      <div id="specials-list" style="margin-top:16px;"></div>
      <button class="btn btn-outline" onclick="openAddSpecial()" style="margin-top:12px;">+ Add Discounted Item</button>
    </div>

    <!-- Happy Hour -->
    <div class="card">
      <div style="background:#FFF7ED;border:1.5px solid #FDBA74;border-radius:12px;padding:16px;">
        <h4 style="font-size:15px;font-weight:700;margin-bottom:12px;">üç∫ Happy Hour</h4>
        <div class="form-group" style="margin-bottom:12px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="hh-enabled" onchange="saveSpecials()">
            <span style="font-size:14px;font-weight:600;">Enable Happy Hour</span>
          </label>
        </div>
        <div id="hh-config" style="display:none;">
          <div class="form-group" style="margin-bottom:12px;">
            <label>Label</label>
            <input type="text" id="hh-label" value="Happy Hour" placeholder="e.g. Happy Hour, Cocktail Hour" onchange="saveSpecials()">
          </div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label>Start Time</label>
              <input type="time" id="hh-start" value="16:00" onchange="saveSpecials()">
            </div>
            <div class="form-group">
              <label>End Time</label>
              <input type="time" id="hh-end" value="18:00" onchange="saveSpecials()">
            </div>
          </div>
          <div class="form-group">
            <label>Days</label>
            <div class="tag-picker" id="hh-days">
              <button class="tag-chip" data-day="1" onclick="toggleHHDay(this)">Mon</button>
              <button class="tag-chip" data-day="2" onclick="toggleHHDay(this)">Tue</button>
              <button class="tag-chip" data-day="3" onclick="toggleHHDay(this)">Wed</button>
              <button class="tag-chip" data-day="4" onclick="toggleHHDay(this)">Thu</button>
              <button class="tag-chip" data-day="5" onclick="toggleHHDay(this)">Fri</button>
              <button class="tag-chip" data-day="6" onclick="toggleHHDay(this)">Sat</button>
              <button class="tag-chip" data-day="0" onclick="toggleHHDay(this)">Sun</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- LANGUAGES TAB -->
  <div id="tab-languages" style="display:none;">
    <div class="card">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:8px;">üåç Multi-Language Menu</h3>
      <p style="font-size:13px;color:var(--gray);margin-bottom:20px;">Enable translations so diners can view your menu in their preferred language. Translations are auto-generated and can be edited.</p>
      
      <div id="lang-list" style="margin-bottom:20px;"></div>
      
      <div class="form-group">
        <label>Add Language</label>
        <div style="display:flex;gap:8px;">
          <select id="add-lang-select" style="flex:1;padding:10px 12px;border:1.5px solid #E5E7EB;border-radius:10px;font-size:14px;font-family:inherit;">
          </select>
          <button class="btn btn-primary" onclick="addLanguage()">üåê Add & Translate</button>
        </div>
      </div>
    </div>
    
    <!-- Translation Editor -->
    <div class="card" id="translation-editor-card" style="display:none;margin-top:16px;">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:8px;">‚úèÔ∏è Edit Translations</h3>
      <p style="font-size:13px;color:var(--gray);margin-bottom:16px;">Review and edit auto-generated translations.</p>
      <div class="form-group">
        <label>Language</label>
        <select id="edit-lang-select" onchange="loadTranslationEditor()" style="width:100%;padding:10px 12px;border:1.5px solid #E5E7EB;border-radius:10px;font-size:14px;font-family:inherit;"></select>
      </div>
      <div id="translation-items"></div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div id="tab-settings" style="display:none;">
    <div class="upgrade-banner">
      <div>
        <h3>Upgrade to Pro</h3>
        <p>Unlimited menus, photo uploads, custom fonts & more</p>
      </div>
      <button class="btn" onclick="upgrade()">Upgrade ‚Äî $29/mo</button>
    </div>
    <div class="card">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:20px;">Account</h3>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="settings-email" disabled>
      </div>
      <div class="form-group">
        <label>Plan</label>
        <input type="text" id="settings-plan" disabled>
      </div>
    </div>
    <div class="card" style="margin-top:16px;">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:8px;">üìû Order Button</h3>
      <p style="font-size:13px;color:var(--gray);margin-bottom:16px;">Add a floating "Call to Order" or "WhatsApp Order" button to your public menu.</p>
      <div class="form-group">
        <label>Enable Order Button</label>
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="order-enabled" onchange="toggleOrderConfig()">
          <span style="font-size:14px;">Show order button on menu</span>
        </label>
      </div>
      <div id="order-config-fields" style="display:none;">
        <div class="form-group">
          <label>Type</label>
          <select id="order-type" style="width:100%;padding:10px 12px;border:1.5px solid #E5E7EB;border-radius:10px;font-size:14px;font-family:inherit;">
            <option value="phone">üìû Call to Order</option>
            <option value="whatsapp">üí¨ WhatsApp Order</option>
          </select>
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="text" id="order-value" placeholder="e.g. +1-555-123-4567">
        </div>
        <button class="btn btn-primary" onclick="saveOrderConfig()">Save Order Settings</button>
      </div>
    </div>
  </div>
</div>

<!-- ITEM MODAL -->
<div class="modal-overlay" id="item-modal">
  <div class="modal">
    <h3 id="item-modal-title">Add Item</h3>
    <div class="form-group">
      <label>Name</label>
      <input type="text" id="item-name" placeholder="e.g. Margherita Pizza">
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea id="item-desc" placeholder="e.g. Fresh mozzarella, basil, San Marzano tomatoes"></textarea>
    </div>
    <div class="form-group">
      <label>Price ($)</label>
      <input type="number" id="item-price" step="0.01" min="0" placeholder="0.00">
    </div>
    <div class="form-group">
      <label>Photo</label>
      <div class="image-upload-area" id="image-upload-area" onclick="document.getElementById('item-image-input').click()">
        <span class="upload-text" id="upload-text">üì∑ Click to upload a photo</span>
        <img id="image-preview" style="display:none;">
        <input type="file" id="item-image-input" accept="image/*" onchange="handleImageUpload(this)">
      </div>
      <button class="btn btn-sm btn-danger" id="remove-image-btn" style="display:none;margin-top:8px;" onclick="removeImage()">Remove photo</button>
    </div>
    <div class="form-group">
      <label>Dietary Tags</label>
      <div class="tag-picker" id="tag-picker">
        <button class="tag-chip" data-tag="vegetarian" onclick="toggleTag(this)">üå± Vegetarian</button>
        <button class="tag-chip" data-tag="vegan" onclick="toggleTag(this)">ü•¨ Vegan</button>
        <button class="tag-chip" data-tag="gluten-free" onclick="toggleTag(this)">üåæ Gluten-Free</button>
        <button class="tag-chip" data-tag="spicy" onclick="toggleTag(this)">üå∂Ô∏è Spicy</button>
        <button class="tag-chip" data-tag="nuts" onclick="toggleTag(this)">ü•ú Contains Nuts</button>
        <button class="tag-chip" data-tag="dairy-free" onclick="toggleTag(this)">ü•õ Dairy-Free</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeItemModal()">Cancel</button>
      <button class="btn btn-primary" id="item-save-btn" onclick="saveItem()">Save Item</button>
    </div>
  </div>
</div>

<!-- QR MODAL -->
<div class="modal-overlay" id="qr-modal">
  <div class="modal qr-container">
    <h3>Your QR Code</h3>
    <p style="font-size:14px;color:var(--gray);margin-bottom:16px;">Scan to preview your menu</p>
    <img id="qr-modal-image" src="" alt="QR Code" style="max-width:256px;">
    <div class="qr-url" id="qr-modal-url"></div>
    <div class="modal-actions" style="justify-content:center;">
      <button class="btn btn-outline" onclick="closeQRModal()">Close</button>
      <button class="btn btn-primary" onclick="downloadQR()">‚¨á Download</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let allMenus = [];
let currentMenu = null;
let categories = [];
let editingItem = null;
let editingCategoryId = null;
let currentImageUrl = '';

// Tab navigation (both sidebar and mobile)
document.querySelectorAll('[data-tab]').forEach(a => {
  a.addEventListener('click', e => {
    e.preventDefault();
    const tab = a.dataset.tab;
    showTab(tab);
    // Update active states
    document.querySelectorAll('[data-tab]').forEach(el => el.classList.remove('active'));
    document.querySelectorAll(`[data-tab="${tab}"]`).forEach(el => el.classList.add('active'));
  });
});


// ============ SPECIALS ============
let specialsData = { days: {}, customSpecials: [], happyHour: { enabled: false, start: '16:00', end: '18:00', label: 'Happy Hour', days: [1,2,3,4,5] } };
let selectedSpecialDay = new Date().getDay();

async function loadSpecials() {
  if (!currentMenu) return;
  try {
    const res = await fetch(`/api/menus/${currentMenu.id}/specials`);
    const { specials } = await res.json();
    specialsData = specials || { days: {}, customSpecials: [], happyHour: { enabled: false, start: '16:00', end: '18:00', label: 'Happy Hour', days: [1,2,3,4,5] } };
    if (!specialsData.customSpecials) specialsData.customSpecials = [];
  } catch(e) { console.error(e); }
  renderSpecialsUI();
}

function renderSpecialsUI() {
  const hh = specialsData.happyHour || {};
  document.getElementById('hh-enabled').checked = hh.enabled || false;
  document.getElementById('hh-config').style.display = hh.enabled ? 'block' : 'none';
  document.getElementById('hh-label').value = hh.label || 'Happy Hour';
  document.getElementById('hh-start').value = hh.start || '16:00';
  document.getElementById('hh-end').value = hh.end || '18:00';
  const hhDays = hh.days || [1,2,3,4,5];
  document.querySelectorAll('#hh-days .tag-chip').forEach(c => {
    c.classList.toggle('selected', hhDays.includes(parseInt(c.dataset.day)));
  });
  document.querySelectorAll('[data-sday]').forEach(t => {
    t.classList.toggle('active', parseInt(t.dataset.sday) === selectedSpecialDay);
  });
  renderCustomSpecials();
  renderDaySpecials();
}

const DAY_NAMES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

function renderCustomSpecials() {
  const container = document.getElementById('custom-specials-list');
  const specials = specialsData.customSpecials || [];
  if (specials.length === 0) {
    container.innerHTML = '<p style="color:var(--gray);font-size:13px;padding:8px 0;">No custom specials yet. Create one to get started!</p>';
    return;
  }
  container.innerHTML = specials.map((cs, idx) => {
    const dayLabels = (cs.days || []).map(d => DAY_NAMES[d]).join(', ');
    const activeClass = cs.isActive !== false ? '' : 'opacity:0.5;';
    return `<div class="item-row" style="align-items:flex-start;${activeClass}">
      <div class="item-info" style="flex:1;">
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="item-name">${escHtml(cs.name)}</div>
          <span style="font-size:11px;padding:2px 8px;border-radius:20px;background:${cs.isActive !== false ? '#DCFCE7' : '#FEE2E2'};color:${cs.isActive !== false ? '#166534' : '#991B1B'};font-weight:600;">${cs.isActive !== false ? 'Active' : 'Paused'}</span>
        </div>
        ${cs.description ? `<div style="font-size:12px;color:var(--gray);margin-top:2px;">${escHtml(cs.description)}</div>` : ''}
        <div style="font-size:11px;color:var(--gray);margin-top:4px;">
          üìÖ ${dayLabels || 'No days set'}
          ${cs.endTime ? ' ¬∑ ‚è∞ Until ' + cs.endTime : ''}
          ${cs.label ? ' ¬∑ üè∑Ô∏è ' + escHtml(cs.label) : ''}
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        ${cs.originalPrice ? `<span style="text-decoration:line-through;color:var(--gray);font-size:13px;">$${Number(cs.originalPrice).toFixed(2)}</span>` : ''}
        <span style="font-weight:800;color:var(--orange);font-size:16px;">$${Number(cs.price).toFixed(2)}</span>
      </div>
      <div style="display:flex;gap:4px;">
        <button class="icon-btn" onclick="toggleCustomSpecial(${idx})" title="${cs.isActive !== false ? 'Pause' : 'Activate'}">${cs.isActive !== false ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}</button>
        <button class="icon-btn" onclick="editCustomSpecial(${idx})">‚úèÔ∏è</button>
        <button class="icon-btn" onclick="removeCustomSpecial(${idx})">üóë</button>
      </div>
    </div>`;
  }).join('');
}

function openCreateCustomSpecial(editIdx) {
  const isEdit = editIdx !== undefined;
  const cs = isEdit ? specialsData.customSpecials[editIdx] : {};
  const days = cs.days || [];

  let html = `<div class="modal"><h3>${isEdit ? 'Edit' : 'Create'} Daily Special</h3>
    <div class="form-group"><label>Name *</label><input type="text" id="cs-name" value="${escHtml(cs.name || '')}" placeholder="e.g. Taco Tuesday Special"></div>
    <div class="form-group"><label>Description</label><textarea id="cs-desc" rows="2" placeholder="e.g. Two tacos with rice and beans">${escHtml(cs.description || '')}</textarea></div>
    <div class="form-row">
      <div class="form-group"><label>Special Price ($) *</label><input type="number" id="cs-price" step="0.01" min="0" value="${cs.price || ''}" placeholder="9.99"></div>
      <div class="form-group"><label>Original Price ($)</label><input type="number" id="cs-orig-price" step="0.01" min="0" value="${cs.originalPrice || ''}" placeholder="14.99 (shows strikethrough)"></div>
    </div>
    <div class="form-group"><label>Badge Label</label><input type="text" id="cs-label" value="${escHtml(cs.label || '')}" placeholder="e.g. Chef's Pick, Limited Time"></div>
    <div class="form-group"><label>Available Until (optional, for countdown)</label><input type="time" id="cs-endtime" value="${cs.endTime || ''}"></div>
    <div class="form-group"><label>Available Days *</label>
      <div class="tag-picker" id="cs-days">
        ${DAY_NAMES.map((name, i) => `<button type="button" class="tag-chip${days.includes(i) ? ' selected' : ''}" data-day="${i}" onclick="this.classList.toggle('selected')">${name}</button>`).join('')}
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="document.getElementById('cs-modal').remove()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCustomSpecial(${isEdit ? editIdx : 'null'})">${isEdit ? 'Save Changes' : 'Create Special'}</button>
    </div>
  </div>`;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay show';
  overlay.id = 'cs-modal';
  overlay.innerHTML = html;
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
  document.body.appendChild(overlay);
}

async function saveCustomSpecial(editIdx) {
  const name = document.getElementById('cs-name').value.trim();
  const price = parseFloat(document.getElementById('cs-price').value);
  if (!name || isNaN(price)) { showToast('Name and price are required'); return; }

  const days = [...document.querySelectorAll('#cs-days .tag-chip.selected')].map(c => parseInt(c.dataset.day));
  if (days.length === 0) { showToast('Select at least one day'); return; }

  const special = {
    id: editIdx !== null && specialsData.customSpecials[editIdx] ? specialsData.customSpecials[editIdx].id : Date.now().toString(36),
    name,
    description: document.getElementById('cs-desc').value.trim(),
    price,
    originalPrice: parseFloat(document.getElementById('cs-orig-price').value) || null,
    label: document.getElementById('cs-label').value.trim(),
    endTime: document.getElementById('cs-endtime').value || null,
    days,
    isActive: true,
    image_url: ''
  };

  if (editIdx !== null) {
    special.isActive = specialsData.customSpecials[editIdx].isActive !== false;
    specialsData.customSpecials[editIdx] = special;
  } else {
    specialsData.customSpecials.push(special);
  }

  document.getElementById('cs-modal').remove();
  await saveSpecials();
  renderCustomSpecials();
}

function editCustomSpecial(idx) {
  openCreateCustomSpecial(idx);
}

async function toggleCustomSpecial(idx) {
  specialsData.customSpecials[idx].isActive = specialsData.customSpecials[idx].isActive === false ? true : false;
  await saveSpecials();
  renderCustomSpecials();
}

async function removeCustomSpecial(idx) {
  if (!confirm('Remove this special?')) return;
  specialsData.customSpecials.splice(idx, 1);
  await saveSpecials();
  renderCustomSpecials();
}

function renderDaySpecials() {
  const dayData = specialsData.days[selectedSpecialDay] || { items: [] };
  const container = document.getElementById('specials-list');
  if (dayData.items.length === 0) {
    container.innerHTML = '<p style="color:var(--gray);font-size:13px;padding:12px 0;">No discounted items for this day.</p>';
    return;
  }
  const allItems = {};
  categories.forEach(cat => cat.items.forEach(item => allItems[item.id] = item));
  container.innerHTML = dayData.items.map((si, idx) => {
    const item = allItems[si.itemId];
    const name = item ? item.name : 'Unknown item';
    const origPrice = item ? Number(item.price).toFixed(2) : '0.00';
    return `<div class="item-row" style="align-items:center;">
      <div class="item-info" style="flex:1;">
        <div class="item-name">${escHtml(name)}</div>
        <div style="font-size:12px;color:var(--gray);margin-top:2px;">${si.label ? escHtml(si.label) : 'Daily Special'}${si.endTime ? ' ¬∑ Until ' + si.endTime : ''}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="text-decoration:line-through;color:var(--gray);font-size:13px;">${origPrice}</span>
        <span style="font-weight:800;color:var(--orange);font-size:16px;">$${Number(si.specialPrice).toFixed(2)}</span>
      </div>
      <button class="icon-btn" onclick="removeSpecial(${idx})">üóë</button>
    </div>`;
  }).join('');
}

function selectSpecialDay(day) {
  selectedSpecialDay = day;
  renderSpecialsUI();
}

function toggleHHDay(el) {
  el.classList.toggle('selected');
  saveSpecials();
}

async function saveSpecials() {
  const hhDays = [...document.querySelectorAll('#hh-days .tag-chip.selected')].map(c => parseInt(c.dataset.day));
  specialsData.happyHour = {
    enabled: document.getElementById('hh-enabled').checked,
    label: document.getElementById('hh-label').value,
    start: document.getElementById('hh-start').value,
    end: document.getElementById('hh-end').value,
    days: hhDays
  };
  document.getElementById('hh-config').style.display = specialsData.happyHour.enabled ? 'block' : 'none';
  await fetch(`/api/menus/${currentMenu.id}/specials`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(specialsData),
  });
  showToast('Specials saved! ‚úÖ');
}

function openAddSpecial() {
  const allItems = [];
  categories.forEach(cat => cat.items.forEach(item => allItems.push({ ...item, catName: cat.name })));
  if (allItems.length === 0) { showToast('Add menu items first!'); return; }
  let pickHtml = '<div class="modal"><h3>Add Discounted Item</h3>';
  pickHtml += '<div class="form-group"><label>Select Item</label><select id="special-item-select" style="width:100%;padding:10px;border:1.5px solid #E5E7EB;border-radius:10px;font-size:14px;font-family:inherit;">';
  allItems.forEach(item => {
    pickHtml += `<option value="${item.id}" data-price="${item.price}">${escHtml(item.catName)} ‚Üí ${escHtml(item.name)} ($${Number(item.price).toFixed(2)})</option>`;
  });
  pickHtml += '</select></div>';
  pickHtml += '<div class="form-group"><label>Special Price ($)</label><input type="number" id="special-price" step="0.01" min="0" placeholder="e.g. 5.99"></div>';
  pickHtml += '<div class="form-group"><label>Label (optional)</label><input type="text" id="special-label" placeholder="e.g. 50% Off"></div>';
  pickHtml += '<div class="form-group"><label>Available Until (optional)</label><input type="time" id="special-endtime" value=""></div>';
  pickHtml += '<div class="modal-actions"><button class="btn btn-outline" onclick="closeSpecialPicker()">Cancel</button><button class="btn btn-primary" onclick="confirmAddSpecial()">Add</button></div>';
  pickHtml += '</div>';
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay show';
  overlay.id = 'special-picker-modal';
  overlay.innerHTML = pickHtml;
  overlay.addEventListener('click', e => { if (e.target === overlay) closeSpecialPicker(); });
  document.body.appendChild(overlay);
  const sel = document.getElementById('special-item-select');
  document.getElementById('special-price').value = (Number(sel.options[sel.selectedIndex].dataset.price) * 0.8).toFixed(2);
  sel.addEventListener('change', () => {
    document.getElementById('special-price').value = (Number(sel.options[sel.selectedIndex].dataset.price) * 0.8).toFixed(2);
  });
}

function closeSpecialPicker() {
  document.getElementById('special-picker-modal')?.remove();
}

async function confirmAddSpecial() {
  const itemId = document.getElementById('special-item-select').value;
  const specialPrice = parseFloat(document.getElementById('special-price').value) || 0;
  const label = document.getElementById('special-label').value;
  const endTime = document.getElementById('special-endtime').value || null;
  if (!specialsData.days[selectedSpecialDay]) specialsData.days[selectedSpecialDay] = { items: [] };
  specialsData.days[selectedSpecialDay].items.push({ itemId, specialPrice, label, endTime });
  closeSpecialPicker();
  await saveSpecials();
  renderDaySpecials();
}

async function removeSpecial(idx) {
  if (!specialsData.days[selectedSpecialDay]) return;
  specialsData.days[selectedSpecialDay].items.splice(idx, 1);
  await saveSpecials();
  renderDaySpecials();
}


// ============ LANGUAGES ============
let supportedLangs = {};
let menuLanguages = [];
let menuTranslations = {};

async function loadLanguages() {
  if (!currentMenu) return;
  try {
    const [langRes, transRes] = await Promise.all([
      fetch('/api/languages'),
      fetch(\`/api/menus/\${currentMenu.id}/translations\`)
    ]);
    const langData = await langRes.json();
    supportedLangs = langData.languages;
    const transData = await transRes.json();
    menuLanguages = transData.languages || [];
    menuTranslations = transData.translations || {};
  } catch(e) { console.error(e); }
  renderLanguagesUI();
}

function renderLanguagesUI() {
  // Render active languages
  const container = document.getElementById('lang-list');
  if (menuLanguages.length === 0) {
    container.innerHTML = '<div style="padding:16px;background:#F9FAFB;border-radius:12px;text-align:center;"><p style="color:var(--gray);font-size:14px;">No languages added yet.</p><p style="color:var(--gray);font-size:12px;margin-top:4px;">Add a language to auto-translate your menu.</p></div>';
  } else {
    container.innerHTML = menuLanguages.map(lang => {
      const info = supportedLangs[lang] || { flag: 'üè≥Ô∏è', name: lang, nativeName: lang };
      const transCount = menuTranslations[lang] ? Object.keys(menuTranslations[lang]).length : 0;
      return \`<div style="display:flex;align-items:center;gap:12px;padding:12px;background:#F9FAFB;border-radius:12px;margin-bottom:8px;">
        <span style="font-size:28px;">\${info.flag}</span>
        <div style="flex:1;">
          <div style="font-weight:700;font-size:14px;">\${info.nativeName} <span style="color:var(--gray);font-weight:400;">(\${info.name})</span></div>
          <div style="font-size:12px;color:var(--gray);">\${transCount} items translated</div>
        </div>
        <button class="btn btn-sm btn-outline" onclick="retranslateLanguage('\${lang}')">üîÑ Re-translate</button>
        <button class="btn btn-sm btn-danger" onclick="removeLanguage('\${lang}')">üóë</button>
      </div>\`;
    }).join('');
  }

  // Render "add language" dropdown (exclude already added)
  const addSelect = document.getElementById('add-lang-select');
  const available = Object.entries(supportedLangs).filter(([code]) => code !== 'en' && !menuLanguages.includes(code));
  addSelect.innerHTML = available.map(([code, info]) => \`<option value="\${code}">\${info.flag} \${info.nativeName} (\${info.name})</option>\`).join('');
  if (available.length === 0) addSelect.innerHTML = '<option>All languages added!</option>';

  // Render edit language dropdown
  const editSelect = document.getElementById('edit-lang-select');
  const editorCard = document.getElementById('translation-editor-card');
  if (menuLanguages.length > 0) {
    editorCard.style.display = 'block';
    editSelect.innerHTML = menuLanguages.map(lang => {
      const info = supportedLangs[lang] || { flag: 'üè≥Ô∏è', name: lang };
      return \`<option value="\${lang}">\${info.flag} \${info.name}</option>\`;
    }).join('');
    loadTranslationEditor();
  } else {
    editorCard.style.display = 'none';
  }
}

async function addLanguage() {
  const lang = document.getElementById('add-lang-select').value;
  if (!lang || !supportedLangs[lang]) return;
  showToast(\`Translating to \${supportedLangs[lang].nativeName}...\`);
  const res = await fetch(\`/api/menus/\${currentMenu.id}/translate\`, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ language: lang })
  });
  const data = await res.json();
  if (data.success) {
    if (!currentMenu.languages) currentMenu.languages = [];
    if (!currentMenu.languages.includes(lang)) currentMenu.languages.push(lang);
    showToast(\`\${supportedLangs[lang].flag} \${supportedLangs[lang].nativeName} added! \${data.translatedCount} items translated ‚úÖ\`);
    await loadLanguages();
    renderMenuSelect();
  } else {
    showToast('Translation failed: ' + (data.error || 'unknown'));
  }
}

async function retranslateLanguage(lang) {
  showToast(\`Re-translating to \${supportedLangs[lang]?.nativeName || lang}...\`);
  const res = await fetch(\`/api/menus/\${currentMenu.id}/translate\`, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ language: lang })
  });
  const data = await res.json();
  if (data.success) {
    showToast(\`Re-translated! \${data.translatedCount} items ‚úÖ\`);
    await loadLanguages();
  }
}

async function removeLanguage(lang) {
  const info = supportedLangs[lang] || { name: lang };
  if (!confirm(\`Remove \${info.name} translations?\`)) return;
  await fetch(\`/api/menus/\${currentMenu.id}/translations/\${lang}\`, { method: 'DELETE' });
  if (currentMenu.languages) currentMenu.languages = currentMenu.languages.filter(l => l !== lang);
  showToast(\`\${info.name} removed\`);
  await loadLanguages();
  renderMenuSelect();
}

function loadTranslationEditor() {
  const lang = document.getElementById('edit-lang-select').value;
  if (!lang || !menuTranslations[lang]) {
    document.getElementById('translation-items').innerHTML = '<p style="color:var(--gray);">No translations to edit.</p>';
    return;
  }
  const trans = menuTranslations[lang];
  let html = '';
  categories.forEach(cat => {
    const catTrans = trans[cat.id] || {};
    html += \`<div style="margin-top:16px;margin-bottom:8px;font-weight:700;font-size:14px;color:var(--orange);">\${escHtml(cat.name)} ‚Üí \${escHtml(catTrans.name || cat.name)}</div>\`;
    html += \`<div class="form-row" style="margin-bottom:8px;">
      <div class="form-group"><label>Category Name</label><input type="text" value="\${escHtml(catTrans.name || '')}" onchange="updateTranslation('\${lang}','\${cat.id}',this.value,null)" placeholder="\${escHtml(cat.name)}"></div>
      <div class="form-group"><label>Description</label><input type="text" value="\${escHtml(catTrans.description || '')}" onchange="updateTranslation('\${lang}','\${cat.id}',null,this.value)" placeholder="\${escHtml(cat.description || '')}"></div>
    </div>\`;
    (cat.items || []).forEach(item => {
      const itemTrans = trans[item.id] || {};
      html += \`<div style="padding:8px 0 8px 16px;border-left:2px solid #E5E7EB;margin-bottom:4px;">
        <div style="font-size:12px;color:var(--gray);margin-bottom:4px;">\${escHtml(item.name)} ‚Äî $\${Number(item.price).toFixed(2)}</div>
        <div class="form-row">
          <div class="form-group"><label style="font-size:11px;">Name</label><input type="text" value="\${escHtml(itemTrans.name || '')}" onchange="updateTranslation('\${lang}','\${item.id}',this.value,null)" placeholder="\${escHtml(item.name)}" style="font-size:13px;padding:8px 10px;"></div>
          <div class="form-group"><label style="font-size:11px;">Description</label><input type="text" value="\${escHtml(itemTrans.description || '')}" onchange="updateTranslation('\${lang}','\${item.id}',null,this.value)" placeholder="\${escHtml(item.description || '')}" style="font-size:13px;padding:8px 10px;"></div>
        </div>
      </div>\`;
    });
  });
  document.getElementById('translation-items').innerHTML = html;
}

async function updateTranslation(lang, itemId, name, description) {
  const existing = (menuTranslations[lang] || {})[itemId] || {};
  const body = {
    name: name !== null ? name : existing.name || '',
    description: description !== null ? description : existing.description || ''
  };
  await fetch(\`/api/menus/\${currentMenu.id}/translations/\${lang}/\${itemId}\`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!menuTranslations[lang]) menuTranslations[lang] = {};
  menuTranslations[lang][itemId] = body;
  showToast('Translation updated ‚úÖ');
}

async function init() {
  try {
    const authRes = await fetch('/api/auth/me');
    if (!authRes.ok) { window.location.href = '/login'; return; }
    const { user } = await authRes.json();
    document.getElementById('user-email').textContent = user.email;
    document.getElementById('settings-email').value = user.email;
    document.getElementById('settings-plan').value = (user.plan || 'free').charAt(0).toUpperCase() + (user.plan || 'free').slice(1);
    document.getElementById('rest-name').value = user.restaurantName || '';
    document.getElementById('rest-hours').value = user.hours || '';
    document.getElementById('rest-location').value = user.location || '';
    document.getElementById('rest-phone').value = user.phone || '';

    const menusRes = await fetch('/api/menus');
    const data = await menusRes.json();
    allMenus = data.menus;
    if (allMenus.length === 0) return;

    renderMenuSelect();
    currentMenu = allMenus[0];
    await selectMenu(currentMenu.id);

    const params = new URLSearchParams(window.location.search);
    if (params.get('upgraded')) showToast('üéâ Welcome to Pro!');
    if (params.get('cancelled')) showToast('Upgrade cancelled.');
  } catch (e) { console.error(e); }
}

function renderMenuSelect() {
  const sel = document.getElementById('menu-select');
  sel.innerHTML = allMenus.map(m => {
    const langs = (m.languages || []).length;
    const badge = langs > 0 ? ` (${langs} lang)` : '';
    return \`<option value="${m.id}">${escHtml(m.name)}${badge}</option>\`;
  }).join('');
  document.getElementById('delete-menu-btn').style.display = allMenus.length > 1 ? 'inline-flex' : 'none';
}

async function selectMenu(menuId) {
  currentMenu = allMenus.find(m => m.id === menuId);
  if (!currentMenu) return;
  document.getElementById('menu-select').value = menuId;

  const menuUrl = window.location.origin + '/m/' + currentMenu.slug;
  document.getElementById('menu-url-display').href = menuUrl;
  document.getElementById('menu-url-display').textContent = menuUrl;
  document.getElementById('preview-link').href = menuUrl;
  document.getElementById('design-menu-name').value = currentMenu.name;
  document.getElementById('design-description').value = currentMenu.description || '';
  document.getElementById('design-primary').value = currentMenu.primary_color || '#E85D2C';
  document.getElementById('design-bg').value = currentMenu.bg_color || '#FFFBF7';
  document.getElementById('primary-label').textContent = currentMenu.primary_color || '#E85D2C';
  document.getElementById('bg-label').textContent = currentMenu.bg_color || '#FFFBF7';
  if (currentMenu.font) document.getElementById('design-font').value = currentMenu.font;
  currentTheme = currentMenu.theme || 'classic';
  document.querySelectorAll('.theme-option').forEach(el => {
    el.classList.toggle('selected', el.dataset.theme === currentTheme);
  });

  await loadCategories();
  await loadQR();
  await loadSpecials();
  await loadLanguages();
  loadOrderConfig();
}

function switchMenu() {
  selectMenu(document.getElementById('menu-select').value);
}

async function addMenu() {
  const name = prompt('Menu name (e.g. Lunch Menu, Drinks, Desserts):');
  if (!name) return;
  const res = await fetch('/api/menus', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name }),
  });
  const { menu } = await res.json();
  allMenus.push(menu);
  renderMenuSelect();
  await selectMenu(menu.id);
  showToast('Menu created! üéâ');
}

async function deleteMenu() {
  if (!confirm(`Delete "${currentMenu.name}" and all its items?`)) return;
  await fetch(`/api/menus/${currentMenu.id}`, { method: 'DELETE' });
  allMenus = allMenus.filter(m => m.id !== currentMenu.id);
  renderMenuSelect();
  await selectMenu(allMenus[0].id);
  showToast('Menu deleted');
}

async function loadCategories() {
  const res = await fetch(`/api/menus/${currentMenu.id}/categories`);
  const data = await res.json();
  categories = data.categories;
  renderCategories();
}

function renderCategories() {
  const container = document.getElementById('categories-container');
  if (categories.length === 0) {
    container.innerHTML = '<div class="card" style="text-align:center;padding:48px;"><p style="color:var(--gray);margin-bottom:16px;">No categories yet. Add your first one!</p><button class="btn btn-primary" onclick="addCategory()">+ Add Category</button></div>';
    return;
  }
  container.innerHTML = categories.map(cat => `
    <div class="card" data-cat-id="${cat.id}" draggable="true" ondragstart="catDragStart(event, '${cat.id}')" ondragend="catDragEnd(event)" ondragover="catDragOver(event)" ondragleave="catDragLeave(event)" ondrop="catDrop(event, '${cat.id}')">
      <div class="category-header">
        <span class="drag-handle" title="Drag to reorder category">‚†ø</span>
        <h3 contenteditable="true" onblur="updateCategoryName('${cat.id}', this.textContent)">${escHtml(cat.name)}</h3>
        <div class="category-actions">
          <button class="btn btn-sm btn-green" onclick="openAddItem('${cat.id}')">+ Add Item</button>
          <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat.id}')">üóë</button>
        </div>
      </div>
      ${cat.items.length === 0 ? '<p style="color:var(--gray);font-size:13px;padding:8px 0;">No items yet. Drag items here or click + Add Item.</p>' : ''}
      ${cat.items.map(item => `
        <div class="item-row${item.is_available ? '' : ' unavailable'}" draggable="true" data-item-id="${item.id}" data-cat-id="${cat.id}" ondragstart="itemDragStart(event, '${item.id}', '${cat.id}')" ondragend="itemDragEnd(event)" ondragover="itemDragOver(event)" ondragleave="itemDragLeave(event)" ondrop="itemDrop(event, '${item.id}', '${cat.id}')">
          <span class="drag-handle" title="Drag to reorder">‚†ø</span>
          ${item.image_url
            ? `<img class="item-thumb" src="${item.image_url}" alt="">`
            : `<div class="item-thumb-placeholder">üçΩ</div>`}
          <div class="item-info">
            <div class="item-name">${escHtml(item.name)}${item.is_available ? '' : '<span class="sold-badge">SOLD OUT</span>'}</div>
            <div class="item-desc">${escHtml(item.description)}</div>
            <div class="item-tags">
              ${(item.tags || []).map(t => `<span class="item-tag">${escHtml(formatTag(t))}</span>`).join('')}
            </div>
          </div>
          <div class="item-price">$${Number(item.price).toFixed(2)}</div>
          <label class="avail-toggle" title="${item.is_available ? 'Available' : 'Sold out ‚Äî click to make available'}">
            <input type="checkbox" ${item.is_available ? 'checked' : ''} onchange="toggleAvailability('${item.id}', this.checked)">
            <span class="slider"></span>
          </label>
          <div class="item-actions">
            <button class="icon-btn" onclick="duplicateItem('${item.id}')" title="Duplicate">üìã</button>
            <button class="icon-btn" onclick="openEditItem('${cat.id}', '${item.id}')">‚úèÔ∏è</button>
            <button class="icon-btn" onclick="deleteItem('${item.id}', '${cat.id}')">üóë</button>
          </div>
        </div>
      `).join('')}
    </div>
  `).join('');
}

function escHtml(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function formatTag(t) {
  const map = { vegetarian: 'üå± Vegetarian', vegan: 'ü•¨ Vegan', 'gluten-free': 'üåæ GF', spicy: 'üå∂Ô∏è Spicy', nuts: 'ü•ú Nuts', 'dairy-free': 'ü•õ DF' };
  return map[t] || t;
}

async function addCategory() {
  const res = await fetch(`/api/menus/${currentMenu.id}/categories`, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: 'New Category' }),
  });
  const { category } = await res.json();
  categories.push(category);
  renderCategories();
  showToast('Category added!');
}

async function updateCategoryName(catId, name) {
  await fetch(`/api/categories/${catId}`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: name.trim() }),
  });
}

async function deleteCategory(catId) {
  if (!confirm('Delete this category and all its items?')) return;
  await fetch(`/api/categories/${catId}`, { method: 'DELETE' });
  categories = categories.filter(c => c.id !== catId);
  renderCategories();
  showToast('Category deleted');
}

function openAddItem(catId) {
  editingItem = null;
  editingCategoryId = catId;
  currentImageUrl = '';
  document.getElementById('item-modal-title').textContent = 'Add Item';
  document.getElementById('item-name').value = '';
  document.getElementById('item-desc').value = '';
  document.getElementById('item-price').value = '';
  document.getElementById('image-preview').style.display = 'none';
  document.getElementById('upload-text').style.display = '';
  document.getElementById('remove-image-btn').style.display = 'none';
  document.querySelectorAll('.tag-chip').forEach(c => c.classList.remove('selected'));
  document.getElementById('item-modal').classList.add('show');
}

function openEditItem(catId, itemId) {
  const cat = categories.find(c => c.id === catId);
  const item = cat?.items.find(i => i.id === itemId);
  if (!item) return;
  editingItem = item;
  editingCategoryId = catId;
  currentImageUrl = item.image_url || '';
  document.getElementById('item-modal-title').textContent = 'Edit Item';
  document.getElementById('item-name').value = item.name;
  document.getElementById('item-desc').value = item.description;
  document.getElementById('item-price').value = item.price;

  if (item.image_url) {
    document.getElementById('image-preview').src = item.image_url;
    document.getElementById('image-preview').style.display = 'block';
    document.getElementById('upload-text').style.display = 'none';
    document.getElementById('remove-image-btn').style.display = 'inline-flex';
  } else {
    document.getElementById('image-preview').style.display = 'none';
    document.getElementById('upload-text').style.display = '';
    document.getElementById('remove-image-btn').style.display = 'none';
  }

  document.querySelectorAll('.tag-chip').forEach(c => {
    c.classList.toggle('selected', (item.tags || []).includes(c.dataset.tag));
  });
  document.getElementById('item-modal').classList.add('show');
}

function closeItemModal() { document.getElementById('item-modal').classList.remove('show'); }
function toggleTag(el) { el.classList.toggle('selected'); }
function getSelectedTags() { return [...document.querySelectorAll('.tag-chip.selected')].map(c => c.dataset.tag); }

async function handleImageUpload(input) {
  if (!input.files[0]) return;
  const formData = new FormData();
  formData.append('image', input.files[0]);
  try {
    const res = await fetch('/api/upload', { method: 'POST', body: formData });
    const { url } = await res.json();
    currentImageUrl = url;
    document.getElementById('image-preview').src = url;
    document.getElementById('image-preview').style.display = 'block';
    document.getElementById('upload-text').style.display = 'none';
    document.getElementById('remove-image-btn').style.display = 'inline-flex';
  } catch (e) { showToast('Upload failed'); }
}

function removeImage() {
  currentImageUrl = '';
  document.getElementById('image-preview').style.display = 'none';
  document.getElementById('upload-text').style.display = '';
  document.getElementById('remove-image-btn').style.display = 'none';
  document.getElementById('item-image-input').value = '';
}

async function saveItem() {
  const data = {
    name: document.getElementById('item-name').value,
    description: document.getElementById('item-desc').value,
    price: parseFloat(document.getElementById('item-price').value) || 0,
    tags: getSelectedTags(),
    image_url: currentImageUrl,
  };

  if (editingItem) {
    await fetch(`/api/items/${editingItem.id}`, {
      method: 'PUT', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    showToast('Item updated!');
  } else {
    const res = await fetch(`/api/categories/${editingCategoryId}/items`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    // Set image_url on newly created item
    if (currentImageUrl) {
      const { item } = await res.json();
      await fetch(`/api/items/${item.id}`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image_url: currentImageUrl }),
      });
    }
    showToast('Item added!');
  }

  closeItemModal();
  await loadCategories();
}

async function deleteItem(itemId) {
  if (!confirm('Delete this item?')) return;
  await fetch(`/api/items/${itemId}`, { method: 'DELETE' });
  await loadCategories();
  showToast('Item deleted');
}

async function saveDesign() {
  document.getElementById('primary-label').textContent = document.getElementById('design-primary').value;
  document.getElementById('bg-label').textContent = document.getElementById('design-bg').value;
  await fetch(`/api/menus/${currentMenu.id}`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name: document.getElementById('design-menu-name').value,
      description: document.getElementById('design-description').value,
      primary_color: document.getElementById('design-primary').value,
      bg_color: document.getElementById('design-bg').value,
      font: document.getElementById('design-font').value,
      theme: currentTheme,
    }),
  });
  // Update menu name in selector
  currentMenu.name = document.getElementById('design-menu-name').value;
  renderMenuSelect();
  document.getElementById('menu-select').value = currentMenu.id;
  showToast('Design saved!');
}

async function saveRestaurantInfo() {
  await fetch('/api/auth/profile', {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      restaurantName: document.getElementById('rest-name').value,
      hours: document.getElementById('rest-hours').value,
      location: document.getElementById('rest-location').value,
      phone: document.getElementById('rest-phone').value,
    }),
  });
  showToast('Restaurant info saved! ‚úÖ');
}

async function loadQR() {
  const res = await fetch(`/api/menus/${currentMenu.id}/qr`);
  const { qr, url } = await res.json();
  document.getElementById('qr-image').src = qr;
  document.getElementById('qr-url').textContent = url;
  document.getElementById('qr-modal-image').src = qr;
  document.getElementById('qr-modal-url').textContent = url;
}

function showQRModal() { document.getElementById('qr-modal').classList.add('show'); }
function closeQRModal() { document.getElementById('qr-modal').classList.remove('show'); }

function downloadQR() {
  const a = document.createElement('a');
  a.href = document.getElementById('qr-image').src;
  a.download = 'menucraft-qr.png';
  a.click();
}

function copyMenuUrl() {
  navigator.clipboard.writeText(document.getElementById('menu-url-display').href).then(() => showToast('URL copied!'));
}

function showTab(tab) {
  ['editor', 'design', 'qr', 'restaurant', 'specials', 'languages', 'settings'].forEach(t => {
    document.getElementById('tab-' + t).style.display = t === tab ? 'block' : 'none';
  });
  const titles = { editor: 'Menu Editor', design: 'Design', qr: 'QR Code', restaurant: 'Restaurant Info', specials: 'Daily Specials', languages: 'Languages', settings: 'Settings' };
  document.getElementById('page-title').textContent = titles[tab];
  // Show/hide menu selector only on editor/design/qr tabs
  const showSelector = ['editor', 'design', 'qr', 'languages'].includes(tab);
  document.getElementById('menu-selector-bar').style.display = showSelector ? 'flex' : 'none';
  document.querySelector('.menu-url-bar').style.display = showSelector ? 'flex' : 'none';
}

async function upgrade() {
  const res = await fetch('/api/checkout', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ plan: 'pro_monthly' }),
  });
  const { url } = await res.json();
  if (url) window.location.href = url;
}

async function logout() {
  await fetch('/api/auth/logout', { method: 'POST' });
  window.location.href = '/';
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

async function toggleAvailability(itemId, available) {
  await fetch(`/api/items/${itemId}`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ is_available: available ? 1 : 0 }),
  });
  await loadCategories();
  showToast(available ? 'Item available ‚úÖ' : 'Marked sold out üö´');
}

let currentTheme = 'classic';
function selectTheme(theme) {
  currentTheme = theme;
  document.querySelectorAll('.theme-option').forEach(el => {
    el.classList.toggle('selected', el.dataset.theme === theme);
  });
  saveDesign();
}

function toggleOrderConfig() {
  document.getElementById('order-config-fields').style.display = document.getElementById('order-enabled').checked ? 'block' : 'none';
}

function loadOrderConfig() {
  if (!currentMenu) return;
  const oc = currentMenu.order_config || { enabled: false, type: 'phone', value: '' };
  document.getElementById('order-enabled').checked = oc.enabled;
  document.getElementById('order-type').value = oc.type || 'phone';
  document.getElementById('order-value').value = oc.value || '';
  document.getElementById('order-config-fields').style.display = oc.enabled ? 'block' : 'none';
}

async function saveOrderConfig() {
  const order_config = {
    enabled: document.getElementById('order-enabled').checked,
    type: document.getElementById('order-type').value,
    value: document.getElementById('order-value').value,
  };
  await fetch(`/api/menus/${currentMenu.id}`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ order_config }),
  });
  currentMenu.order_config = order_config;
  showToast('Order settings saved! ‚úÖ');
}

async function downloadQRCard() {
  const res = await fetch(`/api/menus/${currentMenu.id}/qr-card`);
  const { cardHtml } = await res.json();
  const w = window.open('', '_blank');
  w.document.write(cardHtml);
  w.document.close();
}

document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('show'); });
});


// ============ DRAG & DROP ============
let dragType = null; // 'category' or 'item'
let dragId = null;
let dragCatId = null;

function catDragStart(e, catId) {
  // Only drag if initiated from drag handle
  if (!e.target.closest('.drag-handle') && e.target.className !== 'drag-handle') {
    e.preventDefault(); return;
  }
  dragType = 'category';
  dragId = catId;
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', catId);
  setTimeout(() => e.target.closest('.card').classList.add('dragging'), 0);
}
function catDragEnd(e) {
  document.querySelectorAll('.card').forEach(c => c.classList.remove('dragging','drag-over-top','drag-over-bottom'));
  dragType = null; dragId = null;
}
function catDragOver(e) {
  if (dragType !== 'category') return;
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  const card = e.target.closest('.card[data-cat-id]');
  if (!card) return;
  document.querySelectorAll('.card').forEach(c => c.classList.remove('drag-over-top','drag-over-bottom'));
  const rect = card.getBoundingClientRect();
  const mid = rect.top + rect.height / 2;
  card.classList.add(e.clientY < mid ? 'drag-over-top' : 'drag-over-bottom');
}
function catDragLeave(e) {
  const card = e.target.closest('.card[data-cat-id]');
  if (card) card.classList.remove('drag-over-top','drag-over-bottom');
}
async function catDrop(e, targetCatId) {
  e.preventDefault();
  if (dragType !== 'category' || !dragId || dragId === targetCatId) return;
  document.querySelectorAll('.card').forEach(c => c.classList.remove('drag-over-top','drag-over-bottom','dragging'));
  
  const fromIdx = categories.findIndex(c => c.id === dragId);
  const toIdx = categories.findIndex(c => c.id === targetCatId);
  if (fromIdx < 0 || toIdx < 0) return;
  
  const card = document.querySelector(`.card[data-cat-id="${targetCatId}"]`);
  const rect = card.getBoundingClientRect();
  const insertBefore = e.clientY < rect.top + rect.height / 2;
  
  const [moved] = categories.splice(fromIdx, 1);
  let newIdx = categories.findIndex(c => c.id === targetCatId);
  if (!insertBefore) newIdx++;
  categories.splice(newIdx, 0, moved);
  
  renderCategories();
  const order = categories.map(c => c.id);
  await fetch(`/api/menus/${currentMenu.id}/reorder-categories`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ order }),
  });
  showToast('Categories reordered! ‚úÖ');
}

function itemDragStart(e, itemId, catId) {
  if (!e.target.closest('.drag-handle') && e.target.className !== 'drag-handle') {
    e.preventDefault(); return;
  }
  e.stopPropagation();
  dragType = 'item';
  dragId = itemId;
  dragCatId = catId;
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', itemId);
  setTimeout(() => e.target.closest('.item-row').classList.add('dragging'), 0);
}
function itemDragEnd(e) {
  document.querySelectorAll('.item-row').forEach(r => r.classList.remove('dragging','drag-over-top','drag-over-bottom'));
  dragType = null; dragId = null; dragCatId = null;
}
function itemDragOver(e) {
  if (dragType !== 'item') return;
  e.preventDefault();
  e.stopPropagation();
  e.dataTransfer.dropEffect = 'move';
  const row = e.target.closest('.item-row[data-item-id]');
  if (!row) return;
  document.querySelectorAll('.item-row').forEach(r => r.classList.remove('drag-over-top','drag-over-bottom'));
  const rect = row.getBoundingClientRect();
  const mid = rect.top + rect.height / 2;
  row.classList.add(e.clientY < mid ? 'drag-over-top' : 'drag-over-bottom');
}
function itemDragLeave(e) {
  const row = e.target.closest('.item-row[data-item-id]');
  if (row) row.classList.remove('drag-over-top','drag-over-bottom');
}
async function itemDrop(e, targetItemId, targetCatId) {
  e.preventDefault();
  e.stopPropagation();
  if (dragType !== 'item' || !dragId || dragId === targetItemId) return;
  document.querySelectorAll('.item-row').forEach(r => r.classList.remove('drag-over-top','drag-over-bottom','dragging'));
  
  // Find source category and item
  const srcCat = categories.find(c => c.id === dragCatId);
  const tgtCat = categories.find(c => c.id === targetCatId);
  if (!srcCat || !tgtCat) return;
  
  const srcIdx = srcCat.items.findIndex(i => i.id === dragId);
  if (srcIdx < 0) return;
  const [movedItem] = srcCat.items.splice(srcIdx, 1);
  
  const row = document.querySelector(`.item-row[data-item-id="${targetItemId}"]`);
  const rect = row.getBoundingClientRect();
  const insertBefore = e.clientY < rect.top + rect.height / 2;
  
  let tgtIdx = tgtCat.items.findIndex(i => i.id === targetItemId);
  if (!insertBefore) tgtIdx++;
  tgtCat.items.splice(tgtIdx, 0, movedItem);
  
  renderCategories();
  // Persist order for the target category
  const order = tgtCat.items.map(i => i.id);
  await fetch(`/api/categories/${targetCatId}/reorder-items`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ order }),
  });
  // If moved between categories, also update source
  if (dragCatId !== targetCatId) {
    const srcOrder = srcCat.items.map(i => i.id);
    await fetch(`/api/categories/${dragCatId}/reorder-items`, {
      method: 'PUT', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ order: srcOrder }),
    });
  }
  showToast('Items reordered! ‚úÖ');
}

// ============ DUPLICATE ITEM ============
async function duplicateItem(itemId) {
  const res = await fetch(`/api/items/${itemId}/duplicate`, { method: 'POST' });
  if (res.ok) {
    await loadCategories();
    showToast('Item duplicated! üìã');
  } else {
    showToast('Failed to duplicate');
  }
}

init();
</script>

</body>
</html>
