<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MenuCraft ‚Äî Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root { --orange: #E85D2C; --orange-dark: #D14A1C; --cream: #FFFBF7; --charcoal: #1A1A1A; --gray: #6B7280; --green: #10B981; --red: #EF4444; }
    body { font-family: 'Inter', sans-serif; background: #F9FAFB; color: var(--charcoal); }
    
    .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 240px; background: #fff; border-right: 1px solid #E5E7EB; padding: 20px; display: flex; flex-direction: column; z-index: 50; }
    .sidebar .logo { font-size: 20px; font-weight: 800; color: var(--orange); margin-bottom: 32px; }
    .sidebar .logo span { color: var(--charcoal); }
    .sidebar-nav { flex: 1; }
    .sidebar-nav a { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; text-decoration: none; color: var(--gray); font-size: 14px; font-weight: 500; margin-bottom: 4px; transition: all 0.2s; }
    .sidebar-nav a:hover, .sidebar-nav a.active { background: var(--cream); color: var(--charcoal); }
    .sidebar-nav a.active { font-weight: 600; }
    .sidebar-bottom { border-top: 1px solid #F3F4F6; padding-top: 16px; }
    .sidebar-bottom .user-email { font-size: 12px; color: var(--gray); margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; }
    .sidebar-bottom a { font-size: 13px; color: var(--red); text-decoration: none; font-weight: 500; }

    .main { margin-left: 240px; padding: 32px; min-height: 100vh; }
    .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 12px; }
    .main-header h1 { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
    
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 13px; text-decoration: none; transition: all 0.2s; border: none; cursor: pointer; font-family: inherit; }
    .btn-primary { background: var(--orange); color: #fff; }
    .btn-primary:hover { background: var(--orange-dark); }
    .btn-outline { background: #fff; color: var(--charcoal); border: 1.5px solid #E5E7EB; }
    .btn-outline:hover { border-color: #D1D5DB; }
    .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 8px; }
    .btn-danger { background: #FEE2E2; color: var(--red); }
    .btn-danger:hover { background: #FECACA; }
    .btn-green { background: #ECFDF5; color: var(--green); }

    .card { background: #fff; border-radius: 16px; border: 1px solid #E5E7EB; padding: 24px; margin-bottom: 16px; }

    /* Demo banner */
    .demo-banner {
      background: linear-gradient(135deg, #1A1A1A, #374151);
      color: #fff; padding: 20px 24px; border-radius: 16px;
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
    }
    .demo-banner h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .demo-banner p { font-size: 13px; opacity: 0.8; }
    .demo-banner .btn { background: var(--orange); color: #fff; }

    .menu-url-bar { display: flex; align-items: center; gap: 12px; background: #fff; border: 1.5px solid #E5E7EB; border-radius: 12px; padding: 12px 16px; margin-bottom: 24px; }
    .menu-url-bar .label { font-size: 12px; font-weight: 600; color: var(--gray); white-space: nowrap; }
    .menu-url-bar .url { font-size: 14px; color: var(--orange); font-weight: 600; flex: 1; overflow: hidden; text-overflow: ellipsis; }
    .menu-url-bar .url a { color: inherit; text-decoration: none; }
    .menu-url-bar .url a:hover { text-decoration: underline; }

    .tabs { display: flex; gap: 4px; margin-bottom: 24px; background: #F3F4F6; border-radius: 10px; padding: 4px; width: fit-content; }
    .tab { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; background: transparent; color: var(--gray); border: none; font-family: inherit; }
    .tab.active { background: #fff; color: var(--charcoal); box-shadow: 0 1px 3px rgba(0,0,0,0.08); }

    .category-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .category-header h3 { font-size: 18px; font-weight: 700; }
    .category-actions { display: flex; gap: 8px; }

    .item-row { display: flex; align-items: center; gap: 16px; padding: 12px 0; border-bottom: 1px solid #F3F4F6; }
    .item-row:last-child { border-bottom: none; }
    .item-drag { cursor: grab; color: #D1D5DB; font-size: 16px; }
    .item-info { flex: 1; min-width: 0; }
    .item-name { font-size: 14px; font-weight: 600; }
    .item-desc { font-size: 12px; color: var(--gray); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .item-tags { display: flex; gap: 4px; margin-top: 4px; }
    .item-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #ECFDF5; color: #059669; font-weight: 600; }
    .item-thumb { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; }
    .item-price { font-size: 14px; font-weight: 700; color: var(--orange); white-space: nowrap; }
    .item-actions { display: flex; gap: 4px; }
    .icon-btn { padding: 6px 8px; border: none; background: transparent; cursor: pointer; font-size: 14px; border-radius: 6px; }
    .icon-btn:hover { background: #F3F4F6; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 24px; }
    .modal-overlay.show { display: flex; }
    .modal { background: #fff; border-radius: 20px; padding: 32px; width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; }
    .modal h3 { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #374151; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 12px; border: 1.5px solid #E5E7EB; border-radius: 10px; font-size: 14px; font-family: inherit; outline: none; transition: border-color 0.2s; }
    .form-group input:focus, .form-group textarea:focus { border-color: var(--orange); }
    .form-group textarea { resize: vertical; min-height: 60px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px; }
    .tag-picker { display: flex; gap: 6px; flex-wrap: wrap; }
    .tag-chip { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1.5px solid #E5E7EB; background: #fff; color: var(--gray); transition: all 0.2s; font-family: inherit; }
    .tag-chip.selected { border-color: var(--green); background: #ECFDF5; color: #059669; }

    /* AI description */
    .ai-btn { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; cursor: pointer; border: 1.5px solid #E5E7EB; background: linear-gradient(135deg, #1A1A1A, #374151); color: #fff; font-family: inherit; transition: all 0.2s; }
    .ai-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .ai-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .desc-row { display: flex; gap: 8px; align-items: flex-start; }
    .desc-row textarea { flex: 1; }

    /* Photo upload */
    .photo-upload { margin-top: 8px; }
    .photo-preview { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; margin-bottom: 8px; display: none; }
    .photo-upload-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1.5px dashed #D1D5DB; background: #FAFAFA; color: var(--gray); transition: all 0.2s; }
    .photo-upload-btn:hover { border-color: var(--orange); color: var(--orange); }

    .qr-container { text-align: center; }
    .qr-container img { max-width: 256px; margin: 16px auto; border-radius: 12px; }
    .qr-url { font-size: 14px; color: var(--orange); font-weight: 600; word-break: break-all; margin-bottom: 16px; }

    .color-picker-group { display: flex; align-items: center; gap: 12px; }
    .color-picker-group input[type="color"] { width: 48px; height: 48px; border: 2px solid #E5E7EB; border-radius: 10px; padding: 2px; cursor: pointer; }
    .color-label { font-size: 14px; font-weight: 500; }

    .upgrade-banner { background: linear-gradient(135deg, var(--orange), #F59E0B); color: #fff; padding: 20px 24px; border-radius: 16px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .upgrade-banner h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .upgrade-banner p { font-size: 13px; opacity: 0.9; }
    .upgrade-banner .btn { background: #fff; color: var(--orange); }

    /* Pricing in settings */
    .plan-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
    .plan-card { border: 2px solid #E5E7EB; border-radius: 16px; padding: 24px; text-align: center; }
    .plan-card.recommended { border-color: var(--orange); }
    .plan-card h4 { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .plan-card .plan-price { font-size: 32px; font-weight: 800; margin: 12px 0 4px; }
    .plan-card .plan-price span { font-size: 14px; color: var(--gray); font-weight: 500; }
    .plan-card ul { list-style: none; text-align: left; margin: 16px 0; }
    .plan-card li { font-size: 13px; padding: 4px 0; color: #374151; }
    .plan-card li::before { content: '‚úì '; color: var(--green); font-weight: 700; }

    /* Loading spinner */
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; vertical-align: middle; }
    .spinner.dark { border-color: rgba(0,0,0,0.1); border-top-color: var(--orange); }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Skeleton loading for categories */
    .skeleton-card { background: #fff; border-radius: 16px; border: 1px solid #E5E7EB; padding: 24px; margin-bottom: 16px; }
    .skel-line { height: 14px; border-radius: 6px; background: #F3F4F6; animation: shimmer 1.5s infinite; margin-bottom: 12px; }
    .skel-line.title { width: 30%; height: 20px; }
    .skel-line.item { width: 80%; }
    .skel-line.short { width: 50%; }
    @keyframes shimmer { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* QR loading */
    .qr-loading { display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 40px; color: var(--gray); font-size: 14px; }

    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--charcoal); color: #fff; padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; opacity: 0; transform: translateY(10px); transition: all 0.3s; z-index: 2000; }
    .toast.show { opacity: 1; transform: translateY(0); }

    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main { margin-left: 0; padding: 16px; }
      .plan-cards { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="sidebar">
  <div class="logo">Menu<span>Craft</span></div>
  <div class="sidebar-nav">
    <a href="#" class="active" onclick="showTab('editor')">üìù Menu Editor</a>
    <a href="#" onclick="showTab('design')">üé® Design</a>
    <a href="#" onclick="showTab('qr')">üì∑ QR Code</a>
    <a href="#" onclick="showTab('settings')">‚öôÔ∏è Settings</a>
  </div>
  <div class="sidebar-bottom">
    <div class="user-email" id="user-email">loading...</div>
    <a href="#" onclick="logout()">Log out</a>
  </div>
</div>

<div class="main">
  <!-- Demo banner (hidden by default) -->
  <div class="demo-banner" id="demo-banner" style="display:none;">
    <div>
      <h3>üëã You're in demo mode</h3>
      <p>Your menu is temporary. Sign up to save it, get your QR code, and go live!</p>
    </div>
    <a href="/signup" class="btn">Save & Sign Up Free ‚Üí</a>
  </div>

  <div class="main-header">
    <h1 id="page-title">Menu Editor</h1>
    <div style="display:flex;gap:8px;">
      <a id="preview-link" href="#" target="_blank" class="btn btn-outline">üëÅ Preview</a>
      <button class="btn btn-primary" onclick="showQRModal()">üì∑ QR Code</button>
    </div>
  </div>

  <div class="menu-url-bar">
    <span class="label">Your menu URL:</span>
    <span class="url"><a id="menu-url-display" href="#" target="_blank">loading...</a></span>
    <button class="btn btn-sm btn-outline" onclick="copyMenuUrl()">Copy</button>
  </div>

  <!-- EDITOR TAB -->
  <div id="tab-editor">
    <div id="categories-container"></div>
    <button class="btn btn-outline" onclick="addCategory()" style="margin-top:16px;">+ Add Category</button>
  </div>

  <!-- DESIGN TAB -->
  <div id="tab-design" style="display:none;">
    <div class="card">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:20px;">Customize Your Menu</h3>
      <div class="form-group">
        <label>Menu Name</label>
        <input type="text" id="design-menu-name" onchange="saveDesign()">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="design-description" onchange="saveDesign()" placeholder="e.g. Italian Restaurant ¬∑ Downtown"></textarea>
      </div>
      <div class="form-row" style="margin-bottom:16px;">
        <div class="form-group">
          <label>Primary Color</label>
          <div class="color-picker-group">
            <input type="color" id="design-primary" value="#E85D2C" onchange="saveDesign()">
            <span class="color-label" id="primary-label">#E85D2C</span>
          </div>
        </div>
        <div class="form-group">
          <label>Background Color</label>
          <div class="color-picker-group">
            <input type="color" id="design-bg" value="#FFFBF7" onchange="saveDesign()">
            <span class="color-label" id="bg-label">#FFFBF7</span>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>Font</label>
        <select id="design-font" onchange="saveDesign()">
          <option value="Inter">Inter (Modern)</option>
          <option value="Georgia">Georgia (Classic)</option>
          <option value="Playfair Display">Playfair Display (Elegant)</option>
          <option value="Lora">Lora (Refined)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- QR TAB -->
  <div id="tab-qr" style="display:none;">
    <div class="card qr-container" id="qr-content">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:8px;">Your QR Code</h3>
      <p style="font-size:14px;color:var(--gray);margin-bottom:16px;">Print this and place it on your tables</p>
      <img id="qr-image" src="" alt="QR Code">
      <div class="qr-url" id="qr-url"></div>
      <button class="btn btn-primary" onclick="downloadQR()">‚¨á Download QR Code</button>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div id="tab-settings" style="display:none;">
    <div class="upgrade-banner" id="upgrade-banner">
      <div>
        <h3>Upgrade to Pro</h3>
        <p>Unlimited menus, photos, custom fonts, analytics & more</p>
      </div>
      <button class="btn" onclick="showPricingModal()">View Plans</button>
    </div>
    <div class="card">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:20px;">Account</h3>
      <div class="form-group">
        <label>Restaurant Name</label>
        <input type="text" id="settings-name" disabled>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="settings-email" disabled>
      </div>
      <div class="form-group">
        <label>Plan</label>
        <input type="text" id="settings-plan" disabled>
      </div>
    </div>
  </div>
</div>

<!-- ITEM MODAL -->
<div class="modal-overlay" id="item-modal">
  <div class="modal">
    <h3 id="item-modal-title">Add Item</h3>
    <div class="form-group">
      <label>Name</label>
      <input type="text" id="item-name" placeholder="e.g. Margherita Pizza">
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;justify-content:space-between;">
        Description
        <button class="ai-btn" id="ai-desc-btn" onclick="generateAIDesc()" title="Generate with AI">‚ú® AI Write</button>
      </label>
      <textarea id="item-desc" placeholder="e.g. Fresh mozzarella, basil, San Marzano tomatoes" rows="3"></textarea>
    </div>
    <div class="form-group">
      <label>Price ($)</label>
      <input type="number" id="item-price" step="0.01" min="0" placeholder="0.00">
    </div>
    <div class="form-group">
      <label>Photo</label>
      <img class="photo-preview" id="item-photo-preview">
      <label class="photo-upload-btn">
        üì∑ Upload Photo
        <input type="file" accept="image/*" id="item-photo-input" style="display:none;" onchange="handlePhotoUpload(this)">
      </label>
      <button class="btn btn-sm btn-outline" id="remove-photo-btn" style="display:none;margin-top:8px;margin-left:8px;" onclick="removePhoto()">Remove</button>
    </div>
    <div class="form-group">
      <label>Dietary Tags</label>
      <div class="tag-picker" id="tag-picker">
        <button class="tag-chip" data-tag="vegetarian" onclick="toggleTag(this)">üå± Vegetarian</button>
        <button class="tag-chip" data-tag="vegan" onclick="toggleTag(this)">ü•¨ Vegan</button>
        <button class="tag-chip" data-tag="gluten-free" onclick="toggleTag(this)">GF Gluten-Free</button>
        <button class="tag-chip" data-tag="spicy" onclick="toggleTag(this)">üå∂Ô∏è Spicy</button>
        <button class="tag-chip" data-tag="nuts" onclick="toggleTag(this)">ü•ú Contains Nuts</button>
        <button class="tag-chip" data-tag="dairy-free" onclick="toggleTag(this)">ü•õ Dairy-Free</button>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeItemModal()">Cancel</button>
      <button class="btn btn-primary" id="item-save-btn" onclick="saveItem()">Save Item</button>
    </div>
  </div>
</div>

<!-- QR MODAL -->
<div class="modal-overlay" id="qr-modal">
  <div class="modal qr-container">
    <h3>Your QR Code</h3>
    <p style="font-size:14px;color:var(--gray);margin-bottom:16px;">Scan to preview your menu</p>
    <img id="qr-modal-image" src="" alt="QR Code" style="max-width:256px;">
    <div class="qr-url" id="qr-modal-url"></div>
    <div class="modal-actions" style="justify-content:center;">
      <button class="btn btn-outline" onclick="closeQRModal()">Close</button>
      <button class="btn btn-primary" onclick="downloadQR()">‚¨á Download</button>
    </div>
  </div>
</div>

<!-- PRICING MODAL -->
<div class="modal-overlay" id="pricing-modal">
  <div class="modal" style="max-width:600px;">
    <h3>Choose Your Plan</h3>
    <div class="plan-cards">
      <div class="plan-card">
        <h4>Starter</h4>
        <div class="plan-price">$9<span>/mo</span></div>
        <p style="font-size:12px;color:var(--gray);">or $79/year (save 27%)</p>
        <ul>
          <li>1 menu, 50 items</li>
          <li>QR code</li>
          <li>Custom colors</li>
          <li>AI descriptions</li>
        </ul>
        <button class="btn btn-outline" style="width:100%" onclick="checkout('starter_monthly')">Choose Starter</button>
      </div>
      <div class="plan-card recommended">
        <h4>Pro ‚≠ê</h4>
        <div class="plan-price">$29<span>/mo</span></div>
        <p style="font-size:12px;color:var(--gray);">or $249/year (save 28%)</p>
        <ul>
          <li>Unlimited menus</li>
          <li>Unlimited items</li>
          <li>Photo uploads</li>
          <li>Analytics</li>
          <li>Priority support</li>
        </ul>
        <button class="btn btn-primary" style="width:100%" onclick="checkout('pro_monthly')">Choose Pro</button>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:20px;">
      <button class="btn btn-outline" onclick="closePricingModal()">Maybe Later</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let currentMenu = null;
let categories = [];
let editingItem = null;
let editingCategoryId = null;
let currentPhotoUrl = '';
let isDemo = false;

async function init() {
  try {
    const authRes = await fetch('/api/auth/me');
    if (!authRes.ok) { window.location.href = '/login'; return; }
    const { user } = await authRes.json();
    isDemo = user.isDemo;
    
    if (isDemo) {
      document.getElementById('demo-banner').style.display = 'flex';
      document.getElementById('user-email').textContent = 'Demo Mode';
    } else {
      document.getElementById('user-email').textContent = user.email;
    }
    document.getElementById('settings-name').value = user.restaurantName || '';
    document.getElementById('settings-email').value = user.email || (isDemo ? 'demo@menucraft.com' : '');
    document.getElementById('settings-plan').value = (user.plan || 'free').charAt(0).toUpperCase() + (user.plan || 'free').slice(1);

    const menusRes = await fetch('/api/menus');
    const { menus } = await menusRes.json();
    if (menus.length === 0) return;
    currentMenu = menus[0];

    const menuUrl = window.location.origin + '/m/' + currentMenu.slug;
    document.getElementById('menu-url-display').href = menuUrl;
    document.getElementById('menu-url-display').textContent = menuUrl;
    document.getElementById('preview-link').href = menuUrl;
    document.getElementById('design-menu-name').value = currentMenu.name;
    document.getElementById('design-description').value = currentMenu.description || '';
    document.getElementById('design-primary').value = currentMenu.primary_color || '#E85D2C';
    document.getElementById('design-bg').value = currentMenu.bg_color || '#FFFBF7';
    document.getElementById('primary-label').textContent = currentMenu.primary_color || '#E85D2C';
    document.getElementById('bg-label').textContent = currentMenu.bg_color || '#FFFBF7';
    if (currentMenu.font) document.getElementById('design-font').value = currentMenu.font;

    await loadCategories();
    await loadQR();

    const params = new URLSearchParams(window.location.search);
    if (params.get('upgraded')) showToast('üéâ Welcome to Pro! Enjoy your new features.');
    if (params.get('cancelled')) showToast('Upgrade cancelled.');
  } catch (e) {
    console.error(e);
  }
}

async function loadCategories() {
  // Show skeleton loading
  const container = document.getElementById('categories-container');
  container.innerHTML = `
    <div class="skeleton-card"><div class="skel-line title"></div><div class="skel-line item"></div><div class="skel-line short"></div></div>
    <div class="skeleton-card"><div class="skel-line title"></div><div class="skel-line item"></div><div class="skel-line item"></div><div class="skel-line short"></div></div>
  `;
  const res = await fetch(`/api/menus/${currentMenu.id}/categories`);
  const data = await res.json();
  categories = data.categories;
  renderCategories();
}

function renderCategories() {
  const container = document.getElementById('categories-container');
  if (categories.length === 0) {
    container.innerHTML = '<div class="card" style="text-align:center;padding:48px;"><p style="color:var(--gray);margin-bottom:16px;">No categories yet. Add your first one!</p><button class="btn btn-primary" onclick="addCategory()">+ Add Category</button></div>';
    return;
  }
  container.innerHTML = categories.map(cat => `
    <div class="card" data-cat-id="${cat.id}">
      <div class="category-header">
        <h3 contenteditable="true" onblur="updateCategoryName('${cat.id}', this.textContent)">${esc(cat.name)}</h3>
        <div class="category-actions">
          <button class="btn btn-sm btn-green" onclick="openAddItem('${cat.id}')">+ Add Item</button>
          <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat.id}')">üóë</button>
        </div>
      </div>
      ${cat.items.length === 0 ? '<p style="color:var(--gray);font-size:13px;padding:8px 0;">No items yet. Click "Add Item" to start.</p>' : ''}
      ${cat.items.map(item => `
        <div class="item-row">
          <span class="item-drag">‚†ø</span>
          ${item.image_url ? `<img class="item-thumb" src="${item.image_url}" alt="">` : ''}
          <div class="item-info">
            <div class="item-name">${esc(item.name)}</div>
            <div class="item-desc">${esc(item.description)}</div>
            <div class="item-tags">
              ${(item.tags || []).map(t => `<span class="item-tag">${esc(fmtTag(t))}</span>`).join('')}
            </div>
          </div>
          <div class="item-price">$${Number(item.price).toFixed(2)}</div>
          <div class="item-actions">
            <button class="icon-btn" onclick="openEditItem('${cat.id}', '${item.id}')">‚úèÔ∏è</button>
            <button class="icon-btn" onclick="deleteItem('${item.id}', '${cat.id}')">üóë</button>
          </div>
        </div>
      `).join('')}
    </div>
  `).join('');
}

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function fmtTag(t) {
  const m = { vegetarian: 'üå± Vegetarian', vegan: 'ü•¨ Vegan', 'gluten-free': 'GF', spicy: 'üå∂Ô∏è Spicy', nuts: 'ü•ú Nuts', 'dairy-free': 'ü•õ DF' };
  return m[t] || t;
}

async function addCategory() {
  const res = await fetch(`/api/menus/${currentMenu.id}/categories`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: 'New Category' }) });
  const { category } = await res.json();
  categories.push(category);
  renderCategories();
  showToast('Category added!');
}

async function updateCategoryName(catId, name) {
  await fetch(`/api/categories/${catId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: name.trim() }) });
}

async function deleteCategory(catId) {
  if (!confirm('Delete this category and all its items?')) return;
  await fetch(`/api/categories/${catId}`, { method: 'DELETE' });
  categories = categories.filter(c => c.id !== catId);
  renderCategories();
  showToast('Category deleted');
}

function openAddItem(catId) {
  editingItem = null;
  editingCategoryId = catId;
  currentPhotoUrl = '';
  document.getElementById('item-modal-title').textContent = 'Add Item';
  document.getElementById('item-name').value = '';
  document.getElementById('item-desc').value = '';
  document.getElementById('item-price').value = '';
  document.getElementById('item-photo-preview').style.display = 'none';
  document.getElementById('item-photo-preview').src = '';
  document.getElementById('remove-photo-btn').style.display = 'none';
  document.querySelectorAll('.tag-chip').forEach(c => c.classList.remove('selected'));
  document.getElementById('item-modal').classList.add('show');
}

function openEditItem(catId, itemId) {
  const cat = categories.find(c => c.id === catId);
  const item = cat?.items.find(i => i.id === itemId);
  if (!item) return;
  editingItem = item;
  editingCategoryId = catId;
  currentPhotoUrl = item.image_url || '';
  document.getElementById('item-modal-title').textContent = 'Edit Item';
  document.getElementById('item-name').value = item.name;
  document.getElementById('item-desc').value = item.description;
  document.getElementById('item-price').value = item.price;
  
  const preview = document.getElementById('item-photo-preview');
  const removeBtn = document.getElementById('remove-photo-btn');
  if (item.image_url) {
    preview.src = item.image_url;
    preview.style.display = 'block';
    removeBtn.style.display = 'inline-flex';
  } else {
    preview.style.display = 'none';
    removeBtn.style.display = 'none';
  }
  
  document.querySelectorAll('.tag-chip').forEach(c => {
    c.classList.toggle('selected', (item.tags || []).includes(c.dataset.tag));
  });
  document.getElementById('item-modal').classList.add('show');
}

function closeItemModal() { document.getElementById('item-modal').classList.remove('show'); }
function toggleTag(el) { el.classList.toggle('selected'); }
function getSelectedTags() { return [...document.querySelectorAll('.tag-chip.selected')].map(c => c.dataset.tag); }

async function handlePhotoUpload(input) {
  if (!input.files[0]) return;
  const formData = new FormData();
  formData.append('image', input.files[0]);
  try {
    const res = await fetch('/api/upload', { method: 'POST', body: formData });
    const { url } = await res.json();
    currentPhotoUrl = url;
    const preview = document.getElementById('item-photo-preview');
    preview.src = url;
    preview.style.display = 'block';
    document.getElementById('remove-photo-btn').style.display = 'inline-flex';
    showToast('Photo uploaded!');
  } catch (e) {
    showToast('Upload failed');
  }
}

function removePhoto() {
  currentPhotoUrl = '';
  document.getElementById('item-photo-preview').style.display = 'none';
  document.getElementById('remove-photo-btn').style.display = 'none';
}

// AI Description Generator
async function generateAIDesc() {
  const nameEl = document.getElementById('item-name');
  const descEl = document.getElementById('item-desc');
  const btn = document.getElementById('ai-desc-btn');
  const name = nameEl.value.trim();
  if (!name) { showToast('Enter a dish name first'); return; }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Writing...';
  
  try {
    const res = await fetch('/api/ai/describe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ itemName: name })
    });
    const { description } = await res.json();
    // Typewriter effect
    descEl.value = '';
    let i = 0;
    const interval = setInterval(() => {
      descEl.value += description[i];
      i++;
      if (i >= description.length) clearInterval(interval);
    }, 15);
  } catch (e) {
    showToast('AI generation failed');
  } finally {
    btn.disabled = false;
    btn.textContent = '‚ú® AI Write';
  }
}

async function saveItem() {
  const data = {
    name: document.getElementById('item-name').value,
    description: document.getElementById('item-desc').value,
    price: parseFloat(document.getElementById('item-price').value) || 0,
    tags: getSelectedTags(),
    image_url: currentPhotoUrl,
  };
  
  if (editingItem) {
    await fetch(`/api/items/${editingItem.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    showToast('Item updated!');
  } else {
    await fetch(`/api/categories/${editingCategoryId}/items`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    showToast('Item added!');
  }
  
  closeItemModal();
  await loadCategories();
}

async function deleteItem(itemId) {
  if (!confirm('Delete this item?')) return;
  await fetch(`/api/items/${itemId}`, { method: 'DELETE' });
  await loadCategories();
  showToast('Item deleted');
}

async function saveDesign() {
  document.getElementById('primary-label').textContent = document.getElementById('design-primary').value;
  document.getElementById('bg-label').textContent = document.getElementById('design-bg').value;
  await fetch(`/api/menus/${currentMenu.id}`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name: document.getElementById('design-menu-name').value,
      description: document.getElementById('design-description').value,
      primary_color: document.getElementById('design-primary').value,
      bg_color: document.getElementById('design-bg').value,
      font: document.getElementById('design-font').value,
    }),
  });
  showToast('Design saved!');
}

async function loadQR() {
  document.getElementById('qr-content').innerHTML = `
    <div class="qr-loading"><div class="spinner dark" style="width:32px;height:32px;border-width:3px;"></div><p>Generating QR code...</p></div>
  `;
  const res = await fetch(`/api/menus/${currentMenu.id}/qr`);
  const { qr, url } = await res.json();
  document.getElementById('qr-content').innerHTML = `
    <h3 style="font-size:18px;font-weight:700;margin-bottom:8px;">Your QR Code</h3>
    <p style="font-size:14px;color:var(--gray);margin-bottom:16px;">Print this and place it on your tables</p>
    <img id="qr-image" src="${qr}" alt="QR Code" style="max-width:256px;margin:16px auto;border-radius:12px;">
    <div class="qr-url" id="qr-url">${url}</div>
    <button class="btn btn-primary" onclick="downloadQR()">‚¨á Download QR Code</button>
  `;
  document.getElementById('qr-modal-image').src = qr;
  document.getElementById('qr-modal-url').textContent = url;
}

function showQRModal() { document.getElementById('qr-modal').classList.add('show'); }
function closeQRModal() { document.getElementById('qr-modal').classList.remove('show'); }
function showPricingModal() { document.getElementById('pricing-modal').classList.add('show'); }
function closePricingModal() { document.getElementById('pricing-modal').classList.remove('show'); }

async function checkout(plan) {
  if (isDemo) { window.location.href = '/signup?plan=' + plan; return; }
  try {
    const res = await fetch('/api/checkout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ plan }) });
    const { url, error } = await res.json();
    if (url) window.location.href = url;
    else showToast(error || 'Checkout failed');
  } catch (e) { showToast('Checkout failed'); }
}

function downloadQR() {
  const img = document.getElementById('qr-image');
  const a = document.createElement('a');
  a.href = img.src;
  a.download = 'menucraft-qr.png';
  a.click();
}

function copyMenuUrl() {
  const url = document.getElementById('menu-url-display').href;
  navigator.clipboard.writeText(url).then(() => showToast('URL copied!'));
}

function showTab(tab) {
  ['editor', 'design', 'qr', 'settings'].forEach(t => {
    document.getElementById('tab-' + t).style.display = t === tab ? 'block' : 'none';
  });
  document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
  event.target.closest('a').classList.add('active');
  const titles = { editor: 'Menu Editor', design: 'Design', qr: 'QR Code', settings: 'Settings' };
  document.getElementById('page-title').textContent = titles[tab];
}

async function logout() {
  await fetch('/api/auth/logout', { method: 'POST' });
  window.location.href = '/';
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('show'); });
});

init();
</script>

</body>
</html>
